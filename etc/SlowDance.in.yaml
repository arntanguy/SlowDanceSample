---
# If true, the FSM transitions are managed by an external tool
Managed: false
# If true and the FSM is self-managed, transitions should be triggered
StepByStep: true
# Change idle behaviour, if true the state is kept until transition,
# otherwise the FSM holds the last state until transition
IdleKeepState: true # if code Arnaud false
# Where to look for state libraries
StatesLibraries:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@"
# Where to look for state files
StatesFiles:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@/data"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@/data" # If true, state factory will be more verbose VerboseStateFactory: false
# Additional robots to load
robots:
  ground:
    module: env/ground
  chair:
    module: env/chair
    init_pos:
      translation: [0, 0, 0.2]
  panda_default:
    module: PandaDefault
    init_pos:
      translation: [0, 1, 0]
  ## We don't use the hrp4 section here to set the robot initial position
  # Instead it will be computed in InitialPose state
  # For reference, this is how you would set the robot initial pose from YAML
  #hrp4:
    #init_pos:
       #translation: [0, 0, 0.5]

# General constraints, always on
constraints:
- type: contact
- type: kinematics
  damper: [0.1, 0.01, 0.5]
- type: compoundJoint
# Collision constraint
collisions:
- type: collision
  useMinimal: true
# Initial set of contacts
contacts: []

default_seated_posture_hrp4: &default_seated_posture_hrp4
  R_HIP_Y: [0.0]
  R_HIP_R: [-0.02]
  R_HIP_P: [-1.25]
  R_KNEE_P: [1.4]
  R_ANKLE_P: [0.1]
  R_ANKLE_R: [0.13]
  L_HIP_Y: [0.0]
  L_HIP_R: [0.02]
  L_HIP_P: [-1.25]
  L_KNEE_P: [1.4]
  L_ANKLE_P: [0.1]
  L_ANKLE_R: [-0.13]
  CHEST_P: [0.5]
  CHEST_Y: [0.0]
  NECK_Y: [0.0]
  NECK_P: [0.0]
  R_SHOULDER_P: [-0.052]
  R_SHOULDER_R: [-0.5]
  R_SHOULDER_Y: [0.41]
  R_ELBOW_P: [-1.44]
  R_WRIST_Y: [0.0]
  R_WRIST_P: [-0.057]
  R_WRIST_R: [0.0]
  R_HAND_J0: [0.0]
  R_HAND_J1: [0.0]
  L_SHOULDER_P: [-0.052]
  L_SHOULDER_R: [0.5]
  L_SHOULDER_Y: [-0.41]
  L_ELBOW_P: [-1.44]
  L_WRIST_Y: [0.0]
  L_WRIST_P: [0.057]
  L_WRIST_R: [0.0]
  L_HAND_J0: [0.0]
  L_HAND_J1: [0.0]

# Implement some additional text states
states:
  HRP4::InitialPose:
    base: SlowDance_Initial
    buttock_offset:
      translation: [0.0, 0, 0.05]
      rotation: [0, -0.5, 0]

  # Inherit from this state if you want to start from the current posture
  # and only modify some joints
  CurrentPosture:
    base: Posture
    completion:
      AND:
        - eval: 0.6
        - speed: 0.1
    postureTask:
      stiffness: 10

  # Inherit from this state if you want to define a posture based on the default_seated_posture configuration
  HRP4::DefaultSeatedPosture:
    base: CurrentPosture
    completion:
      AND:
        - eval: 0.5
        - speed: 0.01
    postureTask:
      target:
        <<: *default_seated_posture_hrp4

  # Go the initial posture, that is the default_seated_posture defined above.
  # After reaching that posture, add contacts with the chair.
  # Note: This state is intended to be used with the robot in the air hanging from the ropes, and we will then lower it manually onto the chair
  #       In the future we can consider to write a controller to make it seat by itself, but that's much trickier
  HRP4::InitialPosture:
    base: HRP4::DefaultSeatedPosture
    AddContactsAfter:
      - r1: hrp4
        r2: chair
        r1Surface: Buttock
        r2Surface: Top
      - r1: hrp4
        r2: chair
        r1Surface: Back
        r2Surface: Back

  Panda::InterpolatePosture:
    base: SlowDance_InterpolatePosture
    panda_default:
      posture_task:
        #stiffness: 1000
        stiffness: 10
      improvise: true
      repeat: false
      posture_sequence:
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.41
            panda_joint4: -1.6
            panda_joint5: -0.0
            panda_joint6: 1.85
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.41
            panda_joint4: -2.5
            panda_joint5: -0.0875
            panda_joint6: 1.85
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.41
            panda_joint4: -1.6
            panda_joint5: -0.0
            panda_joint6: 1.85
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.41
            panda_joint4: -2.5
            panda_joint5: -0.0875
            panda_joint6: 1.85
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.41
            panda_joint4: -2.04
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.41
            panda_joint4: -2.04
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: -1.24
        # - time: 2.0
          # posture:
            # panda_joint1: 0.0
            # panda_joint2: 0.22
            # panda_joint3: 0.41
            # panda_joint4: -2.04
            # panda_joint5: -0.0875
            # panda_joint6: 1.85
            # panda_joint7: -1.24
        # - time: 2.0
          # posture:
            # panda_joint1: 0.0
            # panda_joint2: 0.22
            # panda_joint3: 0.41
            # panda_joint4: -1.67
            # panda_joint5: 0.0875
            # panda_joint6: 1.85
            # panda_joint7: 0.94
        #break 
        # - time: 2.0
          # posture:
            # panda_joint1: 0.0
            # panda_joint2: 0.22
            # panda_joint3: 0.69
            # panda_joint4: -1.67
            # panda_joint5: -0.0875
            # panda_joint6: 1.85
            # panda_joint7: 0.94
        - time: 2.0 
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.69
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.69
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94     
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.69
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.69
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94   
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: -0.40
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.69
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: -0.40
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 1.85
            panda_joint7: 0.94
   
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.69
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.67
            panda_joint5: -0.0875
            panda_joint6: 2.46
            panda_joint7: 0.94
        # - time: 2.0 #syncho mains
          # posture:
            # panda_joint1: 0.0
            # panda_joint2: 0.22
            # panda_joint3: 1.5
            # panda_joint4: -2.44
            # panda_joint5: -0.11
            # panda_joint6: 2.46
            # panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.67 #-2.44
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.75 #-2.44
            panda_joint5: -0.11
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.75
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.75
            panda_joint5: -0.11
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.75
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0  #paumes qui tournent
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.75
            panda_joint5: -0.11
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 1.5
            panda_joint4: -1.75
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 0.94    
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -2.44
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -2.4
            panda_joint5: -1.68
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -2.44
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -2.4
            panda_joint5: -1.68
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -2.44
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -2.4
            panda_joint5: -1.68
            panda_joint6: 2.46
            panda_joint7: 0.94
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -1.48
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 1.79
        - time: 2.0
          posture:
           panda_joint1: 0.0
           panda_joint2: 0.22
           panda_joint3: 0.40
           panda_joint4: -2.11
           panda_joint5: -1.10
           panda_joint6: 2.46
           panda_joint7: 1.79
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -1.57
            panda_joint5: -1.10
            panda_joint6: 2.46
            panda_joint7: 1.79
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -1.5
            panda_joint5: -1.1
            panda_joint6: 2.46
            panda_joint7: 1.79
        - time: 2.0
          posture:
            panda_joint1: 0.0
            panda_joint2: 0.22
            panda_joint3: 0.40
            panda_joint4: -2.1
            panda_joint5: -1.1
            panda_joint6: 2.46
            panda_joint7: 1.79    


  HRP4::InterpolatePosture:
    base: SlowDance_InterpolatePosture
    hrp4:
      scaleTime: 1.0
      posture_task:
        stiffness: 1000
      posture_sequence:
        - time: 1.0
          posture:
            R_SHOULDER_P: -0.25
            L_SHOULDER_P: -0.21
            R_ELBOW_P: -0.55
            L_ELBOW_P: -0.20
        - time: 2.0
          posture:
            R_SHOULDER_P: -0.25
            L_SHOULDER_P: -0.21
            R_ELBOW_P: -0.55
            L_ELBOW_P: -0.20
            L_SHOULDER_R: 0.27 #1.38
            L_SHOULDER_Y: -0.28 #1.22
          # shake:
            # NECK_Y:
              # period: 1 # [s]
              # amplitude: 1 # rad
        - time: 2.0
          posture:
            NECK_Y: 0.78
        - time: 2.0
          posture:
            R_ELBOW_P: -1.49
            L_ELBOW_P: -1.68
        - time: 2.0
          posture:
            R_SHOULDER_Y: -0.93
            L_SHOULDER_Y: 0.99
        - time: 2.0
          posture:
            R_SHOULDER_Y: -0.77
            L_SHOULDER_Y: 0.89
        - time: 2.0
          posture:
            R_SHOULDER_Y: -0.77
            L_SHOULDER_Y: 0.89
          shake:
            R_WRIST_R:
              period: 0.1 # [s]
              amplitude: 0.1 # rad
        - time: 2.0
          posture:
            R_SHOULDER_Y: -0.77
            L_SHOULDER_Y: 0.89
        - time: 2.0
          posture:
            R_SHOULDER_P: 0.14
            L_SHOULDER_P: 0.10
        - time: 2.0
          posture:
            R_SHOULDER_P: -0.072
            L_SHOULDER_P: -0.25
            NECK_P: 1.0
        - time: 2.0
          posture:
            R_SHOULDER_P: -0.61 #0.14
            L_SHOULDER_P: -0.68 #0.10
            NECK_P: 1.0
        - time: 2.0
          posture:
            R_SHOULDER_P: -0.072
            L_SHOULDER_P: -0.25
          shake:
            R_SHOULDER_P:
              period: 0.2 # [s]
              amplitude: 0.1 # rad
        - time: 2.0
          posture:
            CHEST_P: 0.39
            R_SHOULDER_P: -1.04
            R_SHOULDER_Y: 0.89
            R_ELBOW_P: -1.81
            R_WRIST_Y: -1.25
            R_WRIST_R: 0.48
          shake:
            NECK_Y:
              period: 0.2 # [s]
              amplitude: 0.1 # rad
        - time: 2.0
          posture:
            L_SHOULDER_Y: 0.48
            R_SHOULDER_Y: 0.38
        - time: 2.0
          posture:
            L_SHOULDER_Y: -0.32
            R_SHOULDER_Y: -0.032
        - time: 2.0
          posture:
            L_SHOULDER_Y: 0.48
            R_SHOULDER_Y: 0.38
        - time: 2.0
          posture:
            L_SHOULDER_Y: -0.32
            R_SHOULDER_Y: -0.032
        - time: 2.0 #sec35
          posture:
            L_ELBOW_P: -0.095
            L_SHOULDER_R: 1.48
            L_SHOULDER_Y: 0.96
            R_ELBOW_P: -0.052
            R_SHOULDER_R: -1.46
            R_SHOULDER_Y: 0.44
        - time: 2.0
          posture:
            L_ELBOW_P: -0.095
            L_SHOULDER_R: 1.48
            L_SHOULDER_Y: -0.54 # 0.96
            R_ELBOW_P: -0.052
            R_SHOULDER_R: -1.46
            R_SHOULDER_Y: 1.34 #0.44
        - time: 2.0
          posture:
            L_ELBOW_P: -0.095
            L_SHOULDER_R: 1.48
            L_SHOULDER_Y: 0.96
            R_ELBOW_P: -0.052
            R_SHOULDER_R: -1.46
            R_SHOULDER_Y: 0.44
        - time: 2.0 #sec 41 new changes posture abder
          posture:
            L_SHOULDER_R: 1.48
            R_SHOULDER_R: -1.46
            R_SHOULDER_Y: -1.12 #new
            L_SHOULDER_P: 0.32
            R_SHOULDER_P: -0.36 #0.21 #- 0.86
            R_ELBOW_P: -1.23
            L_ELBOW_P: -1.20
            L_SHOULDER_Y: -1.05
            R_WRIST_P: 0.44 #new
        - time: 2.0  
          posture:
            L_SHOULDER_R: 1.38
            R_SHOULDER_R: -1.46
            L_SHOULDER_P: 0.32
            R_SHOULDER_P: 0.21
            R_ELBOW_P: -1.55  #-1.23
            L_ELBOW_P: -1.86 #-1.20
            L_SHOULDER_Y: 1.31
            R_SHOULDER_Y: -1.12
        - time: 2.0
          posture:
            L_SHOULDER_R: 1.08
            R_SHOULDER_R: -1.06
            L_SHOULDER_P: 0.32
            R_SHOULDER_P: 0.21
            R_ELBOW_P: -1.55  #-1.47
            L_ELBOW_P: -1.86 #--0.79
            L_SHOULDER_Y: 1.31 #-1.05
            R_SHOULDER_Y: -1.12
          shake:
            NECK_P:
               period: 0.1 # [s]
               amplitude: 0.1 # rad
        - time: 2.0
          posture:
            L_SHOULDER_R: 1.38
            R_SHOULDER_R: -1.46
            L_SHOULDER_P: 0.32
            R_SHOULDER_P: 0.21
            R_ELBOW_P: -1.55  #1.23
            L_ELBOW_P: -1.86 #1.20
            L_SHOULDER_Y: 1.31
            R_SHOULDER_Y: -1.12
        - time: 2.0
          posture:
            L_SHOULDER_R: 1.08
            R_SHOULDER_R: -1.06
            L_SHOULDER_P: 0.32
            R_SHOULDER_P: 0.21
            R_ELBOW_P: -1.55  #1.47
            L_ELBOW_P: -1.86 #0.79
            L_SHOULDER_Y: 1.31
            R_SHOULDER_Y: -1.12

        - time: 2.0 #Ã  revoir selon Abder
          posture:
            L_SHOULDER_R: 1.38
            R_SHOULDER_R: -1.46
            L_SHOULDER_P: 0.32
            R_SHOULDER_P: 0.21
            R_ELBOW_P: -1.55  #1.23
            L_ELBOW_P: -1.86 #1.20
            L_SHOULDER_Y: 1.31
            R_SHOULDER_Y: -1.12
          shake:
            L_ANKLE_R:
              period: 0.1 # [s]
              amplitude: 0.1 # rad
        - time: 2.0
          posture:
            L_SHOULDER_R: 1.08
            R_SHOULDER_R: -1.06
            L_SHOULDER_P: 0.32
            R_SHOULDER_P: 0.21
            R_ELBOW_P: -1.55  #1.47
            L_ELBOW_P: -1.86 #0.79
            L_SHOULDER_Y: 1.31
            R_SHOULDER_Y: -1.22
          shake:
            R_KNEE_P:
             period: 0.1 # [s]
             amplitude: 0.1 # rad
        - time: 2.0
          posture:
            R_ELBOW_P: -1.47
            L_ELBOW_P: -1.47
        - time: 2.0
          posture:
            L_SHOULDER_P: -1.19
            L_SHOULDER_Y: 0.16
            L_ELBOW_P: -0.20
          shake:
            L_WRIST_R:
              period: 0.1 # [s]
              amplitude: 0.1 # rad
        - time: 2.0
          posture:
            L_SHOULDER_P: -1.19
            L_SHOULDER_Y: 0.16
            L_ELBOW_P: -0.20
        - time: 2.0
          posture: {}

  Pause2s:
    base: Pause
    duration: 2
  Pause3s:
    base: Pause
    duration: 3
  Pause5s:
    base: Pause
    duration: 5

  HRP4Demo:
    base: Meta
    StepByStep: false
    transitions:
    - [HRP4::InitialPose, OK, HRP4::InitialPosture, Auto]
    - [HRP4::InitialPosture, OK, HRP4::InterpolatePosture, Strict]
    - [HRP4::InterpolatePosture, Repeat, HRP4::InterpolatePosture, Auto] # repeat demo endlessly
    - [HRP4::InterpolatePosture, Stop, HRP4::InitialPosture, Auto] # Stop

  PandaDemo:
    base: Meta
    StepByStep: false
    transitions:
      - [Panda::InterpolatePosture, Repeat, Panda::InterpolatePosture, Auto] # repeat demo endlessly
      # - [Panda::InterpolatePosture, Stop, Panda::InterpolatePosture, Auto] # repeat demo endlessly

  Both::InterpolatePosture:
    base: Parallel
    states: [Panda::InterpolatePosture, HRP4::InterpolatePosture]
    configs:
      Panda::InterpolatePosture:
        autoplay: true
        robot: panda_default
      HRP4::InterpolatePosture:
        autoplay: true
        robot: hrp4

  Both::Demo:
    base: Meta
    transitions:
      - [HRP4::InitialPose, OK, HRP4::InitialPosture, Auto]
      - [HRP4::InitialPosture, OK, Both::InterpolatePosture, Auto]

  Init::Wait:
    base: Posture

# Transitions map
transitions:
  - [Init::Wait, SingleRobot, RobotTransitionState, Strict]
  - [Init::Wait, MultiRobot, Both::Demo, Strict]
  - [RobotTransitionState, panda_default, PandaDemo, Auto]
  - [RobotTransitionState, hrp4, HRP4Demo, Auto]

# Initial state
init: Init::Wait

ObserverPipelines:
  name: "ObserverPipeline"
  gui: true
  observers:
    - type: Encoder
    - type: Attitude
      required: false
    - type: KinematicInertial
      config:
        anchorFrame:
          maxAnchorFrameDiscontinuity: 0.02
